
    <div class="admin-panel">
      <h1>Gestion Session Globale</h1>

      <div class="status-panel">
        <div *ngIf="currentSession" class="session-info">
          <h2>{{ currentSession.status === 'OPEN' ? 'Session Active' : 'Session Ferm√©e' }}</h2>
          <p>Statut: <strong [class.open]="currentSession.status === 'OPEN'" [class.closed]="currentSession.status === 'CLOSED'">
            {{ currentSession.status }}
          </strong></p>
          <p>Ouvert par: {{ currentSession.openedBy?.firstName }} {{ currentSession.openedBy?.lastName }}</p>
          <p>Depuis: {{ currentSession.openedAt | date: 'dd/MM/yyyy HH:mm' }}</p>
          <p *ngIf="currentSession.status === 'CLOSED' && currentSession.closedAt">Ferm√©e le: {{ currentSession.closedAt | date: 'dd/MM/yyyy HH:mm' }}</p>
          <p>Ventes: {{ formatCurrency(currentSession.totalSales) }}</p>
          <button *ngIf="currentSession.status === 'OPEN'" (click)="openCloseModal()" class="btn btn-danger">
            üîí Fermer Session
          </button>
          <div *ngIf="currentSession.status === 'CLOSED'" class="closed-indicator">
            <span class="lock-icon">üîí</span>
            <span>Session ferm√©e</span>
          </div>
        </div>

        <div *ngIf="!currentSession" class="no-session">
          <p>Aucune session active</p>
          <button (click)="openOpenModal()" class="btn btn-primary">
            üîì Ouvrir Session
          </button>
        </div>
      </div>

      <!-- Open Modal -->
      <div *ngIf="showOpenModal" class="modal">
        <div class="modal-content">
          <h2>Ouvrir Nouvelle Session Globale</h2>
          <p class="text-neutral-400">Voulez-vous ouvrir une nouvelle session globale ?</p>
          <p class="text-neutral-400 text-sm">Les totaux seront calcul√©s √† partir de toutes les sessions de caisse.</p>
          <div class="modal-actions">
            <button (click)="closeModal()" class="btn btn-secondary">Annuler</button>
            <button (click)="openSession()" class="btn btn-primary" [disabled]="loading">
              {{ loading ? 'Ouverture...' : 'Ouvrir' }}
            </button>
          </div>
        </div>
      </div>

      <!-- Close Modal -->
      <div *ngIf="showCloseModal" class="modal">
        <div class="modal-content close-session-modal">
          <h2>Fermer Session Globale</h2>

          <!-- Loading Summary -->
          <div *ngIf="loadingSummary" class="text-center py-4">
            <div class="inline-block animate-spin text-4xl mb-2">‚è≥</div>
            <p class="text-neutral-400">Chargement du r√©sum√©...</p>
          </div>

          <!-- Summary loaded -->
          <div *ngIf="!loadingSummary && sessionSummary" class="space-y-4">

            <!-- Status of cashier sessions -->
            <div class="form-group">
              <label class="block text-sm font-semibold mb-2">√âtat des caisses</label>
              <div class="p-4 bg-neutral-700/50 border border-neutral-600 rounded-lg">
                <p class="text-white mb-1">
                  Total: <strong>{{ sessionSummary.totalCashierSessions }}</strong> caisse(s)
                </p>
                <p class="text-green-400 mb-1">
                  Ferm√©es: <strong>{{ sessionSummary.closedCashierSessions }}</strong>
                </p>
                <p class="text-yellow-400" *ngIf="sessionSummary.openCashierSessions > 0">
                  ‚ö†Ô∏è Encore ouvertes: <strong>{{ sessionSummary.openCashierSessions }}</strong>
                </p>
              </div>
            </div>

            <!-- Total Initial Amount (Read-only) -->
            <div class="form-group">
              <label class="block text-sm font-semibold mb-2">Solde initial total (toutes les caisses)</label>
              <div class="px-4 py-3 bg-neutral-700/50 border border-neutral-600 rounded-lg text-white text-right text-xl">
                {{ formatCurrency(sessionSummary.totalInitialAmount) }}
              </div>
            </div>

            <!-- Total Sales (Read-only) -->
            <div class="form-group">
              <label class="block text-sm font-semibold mb-2">Total ventes</label>
              <div class="px-4 py-3 bg-neutral-700/50 border border-neutral-600 rounded-lg text-green-400 text-right text-xl font-bold">
                {{ formatCurrency(sessionSummary.totalSales) }}
              </div>
            </div>

            <!-- Cash In Operations (Read-only) -->
            <div class="form-group">
              <label class="block text-sm font-semibold mb-2">Total entr√©es de caisse</label>
              <div class="px-4 py-3 bg-neutral-700/50 border border-neutral-600 rounded-lg text-green-400 text-right text-xl">
                +{{ formatCurrency(sessionSummary.totalCashEntrees) }}
              </div>
            </div>

            <!-- Cash Out Operations (Read-only) -->
            <div class="form-group">
              <label class="block text-sm font-semibold mb-2">Total sorties de caisse</label>
              <div class="px-4 py-3 bg-neutral-700/50 border border-neutral-600 rounded-lg text-red-400 text-right text-xl">
                -{{ formatCurrency(sessionSummary.totalCashSorties) }}
              </div>
            </div>

            <!-- Expected Amount (Calculated) -->
            <div class="form-group">
              <label class="block text-sm font-semibold mb-2">Montant attendu</label>
              <div class="px-4 py-3 bg-blue-900/30 border border-blue-700 rounded-lg text-blue-300 text-right text-xl font-bold">
                {{ formatCurrency(sessionSummary.expectedAmount) }}
              </div>
              <p class="text-xs text-neutral-400 mt-1">
                Solde initial + Ventes + Entr√©es - Sorties
              </p>
            </div>

            <!-- Real Amount in Cash (User input) -->
            <div class="form-group">
              <label class="block text-sm font-semibold mb-2">
                Montant r√©el total en caisse (FCFA) <span class="text-red-500">*</span>
              </label>
              <input
                type="number"
                [(ngModel)]="finalAmount"
                min="0"
                placeholder="0"
                class="w-full px-4 py-3 bg-neutral-700 border border-neutral-600 rounded-lg text-white text-right text-xl focus:outline-none focus:border-primary"
                autofocus>
              <p class="text-xs text-neutral-400 mt-2">Comptez l'argent total de toutes les caisses</p>
            </div>

            <!-- Discrepancy (Auto-calculated) -->
            <div *ngIf="finalAmount > 0" class="form-group">
              <label class="block text-sm font-semibold mb-2">√âcart</label>
              <div
                class="px-4 py-3 border rounded-lg text-right text-xl font-bold"
                [class.bg-green-900/30]="discrepancy === 0"
                [class.border-green-700]="discrepancy === 0"
                [class.text-green-400]="discrepancy === 0"
                [class.bg-red-900/30]="discrepancy < 0"
                [class.border-red-700]="discrepancy < 0"
                [class.text-red-400]="discrepancy < 0"
                [class.bg-orange-900/30]="discrepancy > 0"
                [class.border-orange-700]="discrepancy > 0"
                [class.text-orange-400]="discrepancy > 0">
                {{ discrepancyFormatted }}
              </div>
              <p class="text-xs text-neutral-400 mt-2">
                <span *ngIf="discrepancy === 0">‚úì Parfait, aucun √©cart</span>
                <span *ngIf="discrepancy > 0">‚ö†Ô∏è Surplus de {{ formatCurrency(discrepancy) }}</span>
                <span *ngIf="discrepancy < 0">‚ö†Ô∏è Manque de {{ formatCurrency(Math.abs(discrepancy)) }}</span>
              </p>
            </div>

            <!-- Notes (Required) -->
            <div class="form-group">
              <label class="block text-sm font-semibold mb-2">
                Notes <span class="text-red-500">*</span>
              </label>
              <textarea
                [(ngModel)]="reconciliationNotes"
                rows="3"
                placeholder="Observations, incidents, remarques..."
                class="w-full px-4 py-3 bg-neutral-700 border border-neutral-600 rounded-lg text-white focus:outline-none focus:border-primary resize-none"></textarea>
            </div>

            <!-- Error Message -->
            <div *ngIf="error" class="p-3 bg-red-900/30 border border-red-700 rounded-lg text-red-400 text-sm">
              {{ error }}
            </div>
          </div>

          <!-- Modal Actions -->
          <div class="modal-actions">
            <button (click)="closeModal()" class="btn btn-secondary">Annuler</button>
            <button
              (click)="closeSession()"
              class="btn btn-danger"
              [disabled]="loading || !sessionSummary || finalAmount <= 0 || !reconciliationNotes || reconciliationNotes.trim() === ''">
              {{ loading ? 'Fermeture...' : 'üö™ Fermer Session' }}
            </button>
          </div>
        </div>
      </div>

      <div *ngIf="error" class="alert alert-danger">{{ error }}</div>
      <div *ngIf="success" class="alert alert-success">{{ success }}</div>
    </div>
  